language: java

# Setting sudo to false will cause Travis to use Containers (default in the meantime)
sudo: required

services:
  - docker

before_install:
  # - sudo sh -c 'echo net.ipv6.conf.all.disable_ipv6 = 1 >> /etc/sysctl.conf';
  #   sudo sh -c 'echo net.ipv6.conf.default.disable_ipv6 = 1 >> /etc/sysctl.conf';
  #   sudo sh -c 'echo net.ipv6.conf.lo.disable_ipv6 = 1 >> /etc/sysctl.conf';
  #   sudo sysctl -p;
  #   cat /proc/sys/net/ipv6/conf/all/disable_ipv6
  - mkdir exashare
  - docker pull exasol/docker-db:latest
  - docker run --name exasoldb -p 127.0.0.1:8888:8888 -p 127.0.0.1:6583:6583 --detach --privileged --stop-timeout 120 -v $(pwd):/root/exashare exasol/docker-db:latest
  #  --sysctl net.ipv6.conf.all.disable_ipv6=1
  # - docker exec exasoldb sh -c 'sudo yum update -y --exclude=kernel* && sudo yum install -y lsof'
  - docker exec exasoldb sh -c 'sudo rpm -Uvh /root/exashare/lsof-4.82-5.el6.x86_64.rpm'
  # - docker pull sath89/oracle-12c:novnc
  # - docker run --name oracledb -d -p 1521:1521 sath89/oracle-12c:novnc

matrix:
  include:
    - jdk: "oraclejdk8"
      env: MVN_ARGS=""

script:
  - cd jdbc-adapter
  - CONFIG='/home/travis/build/hendrikcech/virtual-schemas/jdbc-adapter/integration-test-data/integration-test-travis.yaml'
  - while [ -z "$W_PW" ]; do W_PW=$(docker exec exasoldb cat /exa/etc/EXAConf | awk '/WritePasswd/{ print $3; }' | base64 -d); sleep 1; done; echo $W_PW
  - sed -i -e "s/BUCKET_FS_PASSWORD/$W_PW/" "$CONFIG"
  - mvn $MVN_ARGS clean package
  - while [ $(docker exec exasoldb find /exa/data/bucketfs/bfsdefault/.dest -name exaudfclient -printf '.' | wc -c) -lt 1 ]; do sleep 1; done
  - mvn $MVN_ARGS pre-integration-test -DskipTests -Pit -Dintegrationtest.configfile="$CONFIG"
  - SCRIPT_OUTPUT_ADDRESS=$(ip addr show docker0 | perl -n -e '/inet ([0-9.]+)/ && print $1')
  - (export IFS=''; python tools/udf_debug.py -s "$SCRIPT_OUTPUT_ADDRESS" -p 3000 |
      while read line; do
        echo "$(date +%H:%M:%S:%N) $line";
      done) &
  - export SCRIPT_OUTPUT_ADDRESS+=":3000"
  - touch /tmp/current.list;
    while true; do
      docker exec exasoldb find /exa/logs/db -iname '*SqlProcess*' > /tmp/next.list;
      grep -Fxvf /tmp/current.list /tmp/next.list | xargs -I{} sh -c 'echo start watching {}; docker exec exasoldb tail -f {} -n 0 &';
      mv /tmp/next.list /tmp/current.list;
      sleep 1;
    done &
  - sleep 60
  # - (echo start sleeping $(date +'%H:%M:%S');
  #    sleep 120;
  #    echo "PS UND LSOF";
  #    sudo lsof -i -u travis;
  #    sudo ps auxww;
  #    docker exec exasoldb sudo lsof -i;
  #    docker exec exasoldb sudo ps auxww) &
  # - sudo ps auxww | grep '/usr/opt/EXASuite' | awk '{ print $2 }' |
  #     xargs -L 1 -I {} sh -c 'echo attaching to pid {}; sudo strace -f -tt -T -e trace=network -p {} &'
  - strace -f -tt -T -e trace=network mvn $MVN_ARGS verify -Pit -Dintegrationtest.configfile="$CONFIG"
